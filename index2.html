<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        .window {
            background-color: red;
            /* border: 1px solid #346789; */
            border-radius: 0.5em;
            box-shadow: 2px 2px 5px #AAAAAA;
            color: black;
            height: 5em;
            position: absolute;
            width: 5em;
        }
        
        .window:hover {
            box-shadow: 2px 2px 19px #AAAAAA;
            cursor: pointer;
        }
        
        .button_add,
        .button_add_window,
        .button_remove,
        .button {
            background-color: deepskyblue;
            text-align: center;
            border: 1px solid;
        }
        
        .button_container {
            margin: 5px;
            background-color: #aaaaaa
        }
        /* .jtk-endpoint {
            background: yellow;
        } */
        
        .aRedEndpoint svg circle {
            fill: red;
            stroke: yellow;
        }
    </style>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.12.6/js/jsplumb.min.js"></script>
</head>

<body>

    <!-- Adds new windows to the page -->
    <div class="window" style="left: 600px" id="details">
        <p style="text-align: center">Window</p>
        <div class="button_container">
            <div class="button_add_window">Add</div>
        </div>
    </div>

    <!-- Primary window - used as html templated for descendants -->
    <div class="window" style="left: 20px" id="container0">
        <div class="button_container">
            <div class="button_add">Add</div>
            <div class="button_remove">Remove</div>
        </div>
    </div>

    <div class="window" style="left: 200px" id="container1">
    </div>

    <div class="window" style="left: 200px; top: 50%; text-align: center;" id="element1">
        Elemento 1
    </div>

    <div class="window" style="left: 900px; top: 50%; text-align: center;" id="element2">
        Elemento 2
    </div>

    <script>
        jsPlumb.ready(function() {

            // jsPlumb.connect({
            //     source: "element1",
            //     target: "element2",
            //     connector: "Flowchart",
            //     endpointHoverStyle: { fill: "red" },
            //     endpointStyle: { fill: "transparent" },
            //     cssClass: "aRedEndpoint",
            //     connectorStyle: { strokeWidth: 5, stroke: 'blue' },
            //     anchor: "AutoDefault",
            //     overlays: [
            //         ["Arrow", {
            //             location: 1,
            //             id: "arrow",
            //             length: 14,
            //             foldback: 0.8
            //         }]
            //     ]
            // });

            var e1 = jsPlumb.addEndpoint("element1", {
                isSource: true,
                isTarget: true,
                connector: ["Flowchart", {
                    cornerRadius: 10,
                    alwaysRespectStubs: true,
                    midpoint: 40
                }],
                connectorStyle: {
                    strokeWidth: 2,
                    stroke: 'blue',
                    cornerRadius: 20
                },
                // connector: ["Flowchart", { cornerRadius: 10, midpoint: 90 }],
                midpoint: 90,
                // cornerRadius: 20,
                // connector: ["StateMachine", { margin: 20, curviness: 15 }],
                anchor: "AutoDefault",
                maxConnections: 5,
                connector: ["Flowchart", {
                    stub: [10, 10],
                    gap: 1,
                    cornerRadius: 5,
                    alwaysRespectStubs: false
                }],
                // connectorStyle: { strokeStyle: "red", lineWidth: 1, outlineColor: "red", outlineWidth: 1 },
                // connectorHoverStyle: { strokeStyle: "red" },
                onMaxConnections: function(info, e) {
                    alert("Maximum connections (" + info.maxConnections + ") reached");
                },
                // fill: 'none',
                // endpoint: ["Rectangle", { radius: 100 }],
                // endpointStyle: { radius: 1, fillStyle: "#000000" },
            });

            var e2 = jsPlumb.addEndpoint("element2", {
                isTarget: true,
                isTarget: true,
                connector: "Flowchart",
                anchor: "AutoDefault",
                maxConnections: 5,

            });

            // var conn = jsPlumb.connect({
            //     source: e1,
            //     target: e2,
            //     overlays: [
            //         ["Arrow", {
            //             location: 1,
            //             id: "arrow",
            //             length: 14,
            //             foldback: 0.8
            //         }]
            //     ],
            //     connector: "Flowchart",
            //     anchor: "AutoDefault",
            // });


            // var endpointOptions = { isSource: true, isTarget: true };
            // var window3Endpoint = jsPlumb.addEndpoint('element1', { anchor: "Top" }, endpointOptions);
            // var window4Endpoint = jsPlumb.addEndpoint('element2', { anchor: "BottomCenter" }, endpointOptions);

            // jsPlumb.connect({
            //     source: window3Endpoint,
            //     target: window4Endpoint,
            //     connector: "Flowchart",
            //     ConnectionOverlays: [
            //         [
            //             'Arrow', { location: 1, id: 'arrow', length: 14, foldback: 0.8 }
            //         ]
            //     ],
            //     paintStyle: { strokeWidth: 5, stroke: 'red' },
            //     connectorOverlays: [
            //         "Arrow", { foldback: 10, location: 1, width: 10 }
            //     ],
            //     overlays: [
            //         ["Label", {
            //             events: {
            //                 click: function (labelOverlay, originalEvent) {
            //                     console.log("click on label overlay for :" + labelOverlay.component);
            //                 }
            //             }
            //         }]
            //     ]
            // });

            // endpointOptions = {
            //     isSource: true,
            //     isTarget: true,
            //     endpoint: ["Dot", { radius: 100 }],
            //     style: { fill: 'blue' },
            //     connector: "Flowchart",
            //     connectorStyle: { strokeWidth: 5, stroke: 'blue' },
            //     endpointStyle: { fill: "blue", outlineStroke: "black", outlineWidth: 60 },
            //     // scope: "blueline",
            //     dropOptions: {
            //         drop: function (e, ui) {
            //             alert('drop!');
            //         }
            //     }
            // };

            jsPlumb.Defaults.Overlays = [
                ["Arrow", {
                    location: 1,
                    id: "arrow",
                    length: 14,
                    foldback: 0.8
                }]
            ];

            // var sourceEndpoint = {
            //     isSource: true, endpoint: "Dot",
            //     connector: "Flowchart",
            //     connectorStyle: { strokeWidth: 5, stroke: 'blue' },
            // };
            // var targetEndpoint = {
            //     endpoint: "Dot",
            //     maxConnections: 5,
            //     connector: "Flowchart",
            //     connectorStyle: { strokeWidth: 10, stroke: 'blue' },
            // };

            // jsPlumb.addEndpoint("element1", sourceEndpoint);
            // jsPlumb.makeTarget("element2", targetEndpoint);

            jsPlumb.bind('contextmenu', (function(that) {
                return function(connection, e) {
                    // jsPlumb.deleteConnection(connection);
                    console.log(connection);
                    console.log(e);

                };
            }(this)));

            jsPlumb.bind('dblclick', (function(that) {
                return function(connection, e) {
                    // jsPlumb.deleteConnection(connection);
                    console.log(connection);
                    console.log(e);
                };
            }(this)));

            //FIX DOM:
            $(("#container1"))[0].innerHTML = $(("#container0"))[0].innerHTML;

            //all windows are draggable
            jsPlumb.draggable($(".window"));

            var anEndpointDestination = {
                endpoint: "Dot",
                isSource: true,
                isTarget: true,
                maxConnections: 5,
                connector: "Flowchart",
                connectorStyle: {
                    strokeWidth: 5,
                    stroke: 'blue'
                },
                anchor: "AutoDefault"
            };

            //Add additional anchor
            $(".button_add").on("click", function() {

                var parentnode = $(this)[0].parentNode.parentNode;

                console.log('Aqui');

                jsPlumb.addEndpoint(
                    parentnode,
                    anEndpointDestination
                );
            });

            // Remove anchor 
            $(".button_remove").on("click", function() {

                var parentnode = $(this)[0].parentNode.parentNode;

                //get list of current endpoints
                var endpoints = jsPlumb.getEndpoints(parentnode);

                //remove 2 last one

                if (endpoints.length > 1) {
                    jsPlumb.deleteEndpoint(endpoints[endpoints.length - 2]);
                }

                if (endpoints.length > 0) {
                    jsPlumb.deleteEndpoint(endpoints[endpoints.length - 1]);
                }

                fixEndpoints(parentnode);
            });


            //adds new window
            $(".button_add_window").click(function() {

                var id = "dynamic_" + $(".window").length;

                //create new window and add it to the body
                $('<div class="window" id="' + id + '" >').appendTo('body').html($(("#container0"))[0].innerHTML);

                jsPlumb.addEndpoint(id, {
                    isSource: true,
                    isTarget: true,
                    connector: ["Flowchart", {
                        cornerRadius: 10,
                        margin: 10,
                        curviness: 15
                    }],
                    connectorStyle: {
                        strokeWidth: 2,
                        stroke: 'blue',
                        cornerRadius: 20
                    },
                    anchor: "AutoDefault",
                    maxConnections: 5,
                    connector: ["Flowchart", {
                        stub: [10, 10],
                        gap: 1,
                        cornerRadius: 5,
                        alwaysRespectStubs: false
                    }],
                    onMaxConnections: function(info, e) {
                        alert("Maximum connections (" + info.maxConnections + ") reached");
                    },
                });

                //set jsplumb properties
                jsPlumb.draggable($('#' + id));
            });
        });
    </script>

</body>

</html>